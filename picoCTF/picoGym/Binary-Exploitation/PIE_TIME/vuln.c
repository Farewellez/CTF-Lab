#include <stdio.h> // ini adalah library standard untuk input output di C. biasa digunakan untuk memanggil printf (cetak output) atau scanf (baca input)
#include <stdlib.h> // standard library untuk fungsi umum seperti exit() atau konversi angka
#include <signal.h> // library untuk menangani sinyal dari OS semisal seperti program crash 
#include <unistd.h>

void segfault_handler() { // void artinya tidak mengembalikkan nilai apapun
  /*
    segfault atau segmentation fault itu adalah error yang ada di bahasa C ketika program  mencoba mengakses alamat memori illegal atau tidak ada
    semisal contoh kita meminta program untuk lompat ke alamat 0x0000 yang kosong. cpu akan menolak dan memberi peringatan SIGSEGV (Signal Segmentation Violation)
  */ 
  printf("Segfault Occurred, incorrect address.\n"); 
  exit(0); // exit 0 artinya keluar dengan aman, jika keluar karena error biasanya menggunakan exit(0)
}

int win() {
  FILE *fptr; // ini adalah cara deklarasi variable pointer khusus untuk file dari situ kita bisa remote file tersebut untuk eksekusi tertentu
  char c; 

  printf("You won!\n");
  // Open file
  fptr = fopen("flag.txt", "r"); // fopen disini digunakan untuk membaca file yang berisi flag dengan opsi read saja
  if (fptr == NULL) // mengembalikkan NULL jika file kosong
  {
      printf("Cannot open file.\n");
      exit(0);
  }

  // Read contents from file
  c = fgetc(fptr); // c variable disini akan menyimpan tiap satu huruf (char) yang ada dipegang oleh remot fptr
  /*
    EOF disini kondisi ketika halaman terakhir dari file sudah habis (End Of File)
    dalam while loop ini, c vaiable akan terus berisi character dari isi file hingga ketemu tanda akhir file
  */
  while (c != EOF) 
  {
      printf ("%c", c);
      c = fgetc(fptr);
  }

  printf("\n");
  fclose(fptr); // fclose disini praktik yang baik agar menutup file setelah di buka (fopen) agar memori tidak bocor
}

int main() {
  signal(SIGSEGV, segfault_handler); // memanggil signal method dari library signal.h yang menangani SIGSEGV dengan handler function pertama yang dibuat (segfault handler)
  /*
    jadi cara kerja C menyimpan data di buffer terlebih dahulu dan akan dikirim ke layar jika buffer penuh atau program selesai
    dengan adanya opsi _IONBF maka tiap 1 huruf yang mau diprint maka akan langsung dicetak ke terminal
    tanpa opsi ini maka besar kemungkinan address dari main tidak keluar
  */ 
  setvbuf(stdout, NULL, _IONBF, 0); // _IONBF = Unbuffered

  printf("Address of main: %p\n", &main); 

  unsigned long val;
  printf("Enter the address to jump to, ex => 0x12345: ");
  scanf("%lx", &val); // alamat memory dari val akan diisi nilai dari input user (akan dianggap hexadecimal format (lx))
  printf("Your input: %lx\n", val);
  /*
    jadi disini ada sebuah trik  cerdas dimana ada sebuah variable foo yang merupakan pointer ke sebuah void function
    nilai alamat dari foo ini akan diisi oleh input user yang di casting untuk menganggap input user itu bukan format angka, tapi format pointer ke suatu address
    saat foo di eksekusi karena sudah dianggap function, maka akan mengeksekusi isi alamat yang diberikan oleh input user (val) yang di chall ini harus alamat win function 
  */
  void (*foo)(void) = (void (*)())val;
  foo();
}